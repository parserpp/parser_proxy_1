name: PythonCI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0/15 * * * *'  # 每15分钟执行一次
  repository_dispatch:
    types:
      - webhook-1

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 30  # 添加总超时限制

    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10"]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4  # 升级到 v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5  # 升级到 v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: Cache pip dependencies
      uses: actions/cache@v4  # 添加缓存加速安装
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

    - name: Run proxy fetcher
      run: |
        echo "Starting proxy fetcher..."
        # 验证默认启用，确保只提交可用代理
        # 如需禁用验证，请使用 --no-verify 参数
        python proxyFetcher.py ${{ secrets.GTOKEN }} --verify
        # python proxyFetcher.py ${{ secrets.GTOKEN }} --no-verify
        echo "Proxy fetcher completed."
      env:
        GITHUB_TOKEN: ${{ secrets.GTOKEN }}
        VERIFY_PROXIES: "true"  # 明确启用验证

    - name: List files
      run: |
        echo "Files in workspace:"
        ls -la

    - name: Check Python version
      run: |
        python --version
        pip --version

    # 如果确实需要 Java 环境，可以取消注释下面这行
    # - name: Check Java version
    #   if: false  # 设置为 false 表示跳过，改为 true 表示启用
    #   run: |
    #     java --version
